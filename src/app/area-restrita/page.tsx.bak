'use client';

import { useState, useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import LoginForm from '../../components/LoginForm';
import Calendario from '@/components/Calendario';
import CheckoutTransparente from '@/components/CheckoutTransparente';

export default function AreaRestritaPage() {
  const { user, isAuthenticated, logout, loading } = useAuth();
  const [userData, setUserData] = useState<any>(null);

  // Carregar dados espec√≠ficos do usu√°rio quando autenticado
  useEffect(() => {
    if (isAuthenticated && user) {
      recarregarDadosPaciente();
    }
  }, [isAuthenticated, user]);

  const recarregarDadosPaciente = async () => {
    if (!user) return;

    try {
      const response = await fetch('/api/area-restrita', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: user.email,
          senha: 'dummy', // N√£o usado na valida√ß√£o com contexto
          tipo: user.tipo
        })
      });

      const result = await response.json();
      if (response.ok && result.success) {
        setUserData(result);
      }
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
    }
  };

  const handleLogout = () => {
    logout();
    setUserData(null);
  };

  const recarregarDadosPaciente = async () => {
    if (userType === 'paciente' && userData?.paciente?.email) {
      try {
        const response = await fetch('/api/area-restrita', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: userData.paciente.email,
            senha: userData.paciente.id.slice(-8), // Usar a mesma l√≥gica de senha
            tipo: 'paciente'
          })
        });

        if (response.ok) {
          const result = await response.json();
          setUserData(result); // Atualizar dados sem perder o login
        }
      } catch (error) {
        console.error('Erro ao recarregar dados do paciente:', error);
      }
    }
  };

  // Componente de Login
  if (loading) {
    return (
      <div style={{
        minHeight: '100vh',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        backgroundColor: '#f7fafc'
      }}>
        <div style={{ textAlign: 'center', color: '#4a5568' }}>
          Carregando...
        </div>
      </div>
    );
  }

  if (!isAuthenticated) {
    return (
      <div style={{ minHeight: '100vh', backgroundColor: '#f8f9fa', fontFamily: 'Arial, sans-serif' }}>
        <header style={{ 
          backgroundColor: '#ffffff', 
          boxShadow: '0 2px 4px rgba(0,0,0,0.1)', 
          padding: '1rem 0' 
        }}>
          <nav style={{ 
            maxWidth: '1200px', 
            margin: '0 auto', 
            display: 'flex', 
            justifyContent: 'space-between', 
            alignItems: 'center',
            padding: '0 2rem'
          }}>
            <Link href="/" style={{ 
              fontSize: '1.5rem', 
              fontWeight: 'bold', 
              color: '#2c3e50',
              textDecoration: 'none'
            }}>
              Psic√≥loga Maria Cristina
            </Link>
          </nav>
        </header>

        <div style={{ 
          display: 'flex', 
          justifyContent: 'center', 
          alignItems: 'center', 
          minHeight: 'calc(100vh - 80px)',
          padding: '2rem'
        }}>
          <div style={{ 
            backgroundColor: 'white', 
            borderRadius: '10px', 
            padding: '3rem', 
            boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
            width: '100%',
            maxWidth: '400px'
          }}>
            <h1 style={{ textAlign: 'center', marginBottom: '2rem', color: '#2c3e50' }}>
              √Årea Restrita
            </h1>

            <form onSubmit={handleLogin}>
              <div style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>
                  Tipo de Acesso
                </label>
                <select
                  value={loginForm.tipo}
                  onChange={(e) => setLoginForm(prev => ({ ...prev, tipo: e.target.value }))}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #ddd',
                    borderRadius: '5px',
                    fontSize: '16px'
                  }}
                >
                  <option value="paciente">Paciente</option>
                  <option value="psicologa">Psic√≥loga</option>
                </select>
              </div>

              <div style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>
                  Email
                </label>
                <input
                  type="email"
                  value={loginForm.email}
                  onChange={(e) => setLoginForm(prev => ({ ...prev, email: e.target.value }))}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #ddd',
                    borderRadius: '5px',
                    fontSize: '16px'
                  }}
                  required
                />
              </div>

              <div style={{ marginBottom: '2rem' }}>
                <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>
                  Senha
                </label>
                <input
                  type="password"
                  value={loginForm.senha}
                  onChange={(e) => setLoginForm(prev => ({ ...prev, senha: e.target.value }))}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #ddd',
                    borderRadius: '5px',
                    fontSize: '16px'
                  }}
                  required
                />
              </div>

              <button
                type="submit"
                disabled={loading}
                style={{
                  width: '100%',
                  padding: '12px',
                  backgroundColor: loading ? '#ccc' : '#3498db',
                  color: 'white',
                  border: 'none',
                  borderRadius: '5px',
                  fontSize: '16px',
                  fontWeight: '500',
                  cursor: loading ? 'not-allowed' : 'pointer'
                }}
              >
                {loading ? 'Entrando...' : 'Entrar'}
              </button>
            </form>

            <div style={{ 
              marginTop: '2rem', 
              padding: '1rem', 
              backgroundColor: '#f8f9fa', 
              borderRadius: '8px',
              fontSize: '14px',
              color: '#666'
            }}>
              <p style={{ margin: '0 0 10px 0' }}><strong>Para Pacientes:</strong></p>
              <p style={{ margin: '0 0 10px 0' }}>Use o email e senha enviados ap√≥s o agendamento.</p>
              
              <p style={{ margin: '10px 0 10px 0' }}><strong>Para Psic√≥loga:</strong></p>
              <p style={{ margin: 0 }}>Email: psicologa@mariacristina.com</p>
              <p style={{ margin: 0 }}>Senha: admin123</p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // √Årea Restrita do Paciente
  if (user?.tipo === 'paciente') {
    return <AreaPaciente 
      userData={userData} 
      onLogout={handleLogout} 
      onAtualizarDados={recarregarDadosPaciente}
    />;
  }

  // √Årea Restrita da Psic√≥loga
  if (user?.tipo === 'psicologa') {
    return <AreaPsicologa userData={userData} onLogout={handleLogout} />;
  }

  return null;
}

// Componente da √Årea do Paciente
function AreaPaciente({ 
  userData, 
  onLogout, 
  onAtualizarDados 
}: { 
  userData: any, 
  onLogout: () => void,
  onAtualizarDados: () => void
}) {
  const [abaSelecionada, setAbaSelecionada] = useState('consultas');
  const [checkoutAberto, setCheckoutAberto] = useState(false);
  const [consultaSelecionada, setConsultaSelecionada] = useState(null);

  // Separar consultas por status
  const consultasProximas = userData.consultas.filter((c: any) => 
    ['agendada', 'confirmada'].includes(c.status) && new Date(c.data) >= new Date()
  );
  
  const consultasHistorico = userData.consultas.filter((c: any) => 
    ['realizada', 'cancelada', 'nao_compareceu'].includes(c.status) || new Date(c.data) < new Date()
  );

  return (
    <div style={{ minHeight: '100vh', backgroundColor: '#f8f9fa', fontFamily: 'Arial, sans-serif' }}>
      <header style={{ 
        backgroundColor: '#ffffff', 
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)', 
        padding: '1rem 0' 
      }}>
        <nav style={{ 
          maxWidth: '1200px', 
          margin: '0 auto', 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          padding: '0 2rem'
        }}>
          <Link href="/" style={{ 
            fontSize: '1.5rem', 
            fontWeight: 'bold', 
            color: '#2c3e50',
            textDecoration: 'none'
          }}>
            Psic√≥loga Maria Cristina
          </Link>
          <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
            <span style={{ color: '#666' }}>Ol√°, {userData.paciente.nome}</span>
            <button 
              onClick={onLogout}
              style={{
                padding: '8px 16px',
                backgroundColor: '#e74c3c',
                color: 'white',
                border: 'none',
                borderRadius: '5px',
                cursor: 'pointer'
              }}
            >
              Sair
            </button>
          </div>
        </nav>
      </header>

      <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '2rem' }}>
        {/* Menu de navega√ß√£o */}
        <div style={{ 
          backgroundColor: 'white', 
          borderRadius: '10px', 
          padding: '1rem',
          marginBottom: '2rem',
          boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
          <div style={{ display: 'flex', gap: '1rem' }}>
            {[
              { key: 'consultas', label: 'Pr√≥ximas Consultas' },
              { key: 'historico', label: 'Hist√≥rico' },
              { key: 'pagamentos', label: 'Pagamentos' }
            ].map(aba => (
              <button
                key={aba.key}
                onClick={() => setAbaSelecionada(aba.key)}
                style={{
                  padding: '10px 20px',
                  backgroundColor: abaSelecionada === aba.key ? '#3498db' : 'transparent',
                  color: abaSelecionada === aba.key ? 'white' : '#666',
                  border: 'none',
                  borderRadius: '5px',
                  cursor: 'pointer',
                  fontWeight: abaSelecionada === aba.key ? '600' : '400'
                }}
              >
                {aba.label}
              </button>
            ))}
          </div>
        </div>

        {/* Pr√≥ximas Consultas */}
        {abaSelecionada === 'consultas' && (
          <div>
            <h1 style={{ marginBottom: '2rem', color: '#2c3e50' }}>Pr√≥ximas Consultas</h1>
            
            {consultasProximas.length === 0 ? (
              <div style={{ 
                backgroundColor: 'white', 
                padding: '3rem', 
                borderRadius: '10px', 
                textAlign: 'center',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
              }}>
                <p style={{ fontSize: '1.2rem', color: '#666' }}>Voc√™ n√£o possui consultas agendadas.</p>
                <Link href="/agendamento" style={{
                  display: 'inline-block',
                  marginTop: '1rem',
                  padding: '12px 24px',
                  backgroundColor: '#3498db',
                  color: 'white',
                  textDecoration: 'none',
                  borderRadius: '5px',
                  fontWeight: '500'
                }}>
                  Agendar Nova Consulta
                </Link>
              </div>
            ) : (
              <div style={{ display: 'grid', gap: '1rem' }}>
                {consultasProximas.map((consulta: any) => (
                  <div key={consulta.id} style={{ 
                    backgroundColor: 'white', 
                    padding: '1.5rem', 
                    borderRadius: '10px',
                    boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <h3 style={{ margin: '0 0 10px 0', color: '#2c3e50' }}>
                          {new Date(consulta.data + 'T12:00:00').toLocaleDateString('pt-BR')} - {consulta.hora}
                        </h3>
                        <p style={{ margin: '0 0 5px 0' }}>
                          <strong>Status:</strong> 
                          <span style={{ 
                            marginLeft: '8px',
                            padding: '4px 8px',
                            borderRadius: '4px',
                            fontSize: '12px',
                            backgroundColor: 
                              consulta.status === 'agendada' ? '#fff3cd' :
                              consulta.status === 'confirmada' ? '#d4edda' :
                              consulta.status === 'realizada' ? '#d1ecf1' : '#f8d7da',
                            color:
                              consulta.status === 'agendada' ? '#856404' :
                              consulta.status === 'confirmada' ? '#155724' :
                              consulta.status === 'realizada' ? '#0c5460' : '#721c24'
                          }}>
                            {consulta.status.charAt(0).toUpperCase() + consulta.status.slice(1)}
                          </span>
                        </p>
                        <p style={{ margin: '0 0 5px 0' }}>
                          <strong>Pagamento:</strong> 
                          <span style={{ 
                            marginLeft: '8px',
                            padding: '4px 8px',
                            borderRadius: '4px',
                            fontSize: '12px',
                            backgroundColor: consulta.pagamento === 'pago' ? '#d4edda' : '#fff3cd',
                            color: consulta.pagamento === 'pago' ? '#155724' : '#856404'
                          }}>
                            {consulta.pagamento.charAt(0).toUpperCase() + consulta.pagamento.slice(1)}
                          </span>
                        </p>
                        <p style={{ margin: 0, fontSize: '14px', color: '#666' }}>
                          <strong>Valor:</strong> R$ 150,00
                        </p>
                      </div>
                      <div>
                        {consulta.linkMeet && consulta.status === 'confirmada' && (
                          <a 
                            href={consulta.linkMeet} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            style={{
                              padding: '10px 20px',
                              backgroundColor: '#27ae60',
                              color: 'white',
                              textDecoration: 'none',
                              borderRadius: '5px',
                              fontWeight: '500',
                              display: 'inline-block'
                            }}
                          >
                            Entrar na Consulta
                          </a>
                        )}
                        {!consulta.linkMeet && consulta.status === 'confirmada' && (
                          <span style={{ 
                            padding: '10px 20px',
                            backgroundColor: '#f39c12',
                            color: 'white',
                            borderRadius: '5px',
                            fontSize: '14px'
                          }}>
                            Link ser√° enviado em breve
                          </span>
                        )}
                        {consulta.pagamento === 'pendente' && (
                          <div style={{ marginTop: '10px' }}>
                            <button
                              style={{
                                padding: '8px 16px',
                                backgroundColor: '#007bff',
                                color: 'white',
                                borderRadius: '5px',
                                fontSize: '14px',
                                cursor: 'pointer',
                                border: 'none'
                              }}
                              onClick={() => {
                                setConsultaSelecionada(consulta);
                                setCheckoutAberto(true);
                              }}
                            >
                              Pagar Consulta
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Hist√≥rico */}
        {abaSelecionada === 'historico' && (
          <div>
            <h1 style={{ marginBottom: '2rem', color: '#2c3e50' }}>Hist√≥rico de Consultas</h1>
            
            {consultasHistorico.length === 0 ? (
              <div style={{ 
                backgroundColor: 'white', 
                padding: '3rem', 
                borderRadius: '10px', 
                textAlign: 'center',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
              }}>
                <p style={{ fontSize: '1.2rem', color: '#666' }}>Nenhuma consulta no hist√≥rico.</p>
              </div>
            ) : (
              <div style={{ display: 'grid', gap: '1rem' }}>
                {consultasHistorico.map((consulta: any) => (
                  <div key={consulta.id} style={{ 
                    backgroundColor: 'white', 
                    padding: '1.5rem', 
                    borderRadius: '10px',
                    boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                    opacity: consulta.status === 'cancelada' ? 0.7 : 1
                  }}>
                    <div>
                      <h3 style={{ margin: '0 0 10px 0', color: '#2c3e50' }}>
                        {new Date(consulta.data + 'T12:00:00').toLocaleDateString('pt-BR')} - {consulta.hora}
                      </h3>
                      <p style={{ margin: '0 0 5px 0' }}>
                        <strong>Status:</strong> 
                        <span style={{ 
                          marginLeft: '8px',
                          padding: '4px 8px',
                          borderRadius: '4px',
                          fontSize: '12px',
                          backgroundColor: 
                            consulta.status === 'realizada' ? '#d1ecf1' : '#f8d7da',
                          color:
                            consulta.status === 'realizada' ? '#0c5460' : '#721c24'
                        }}>
                          {consulta.status.charAt(0).toUpperCase() + consulta.status.slice(1)}
                        </span>
                      </p>
                      <p style={{ margin: '0 0 5px 0' }}>
                        <strong>Pagamento:</strong> 
                        <span style={{ 
                          marginLeft: '8px',
                          padding: '4px 8px',
                          borderRadius: '4px',
                          fontSize: '12px',
                          backgroundColor: consulta.pagamento === 'pago' ? '#d4edda' : 
                                          consulta.pagamento === 'cancelado' ? '#f8d7da' : '#fff3cd',
                          color: consulta.pagamento === 'pago' ? '#155724' : 
                                consulta.pagamento === 'cancelado' ? '#721c24' : '#856404'
                        }}>
                          {consulta.pagamento.charAt(0).toUpperCase() + consulta.pagamento.slice(1)}
                        </span>
                      </p>
                      <p style={{ margin: '0 0 10px 0', fontSize: '14px', color: '#666' }}>
                        <strong>Valor:</strong> R$ 150,00
                      </p>
                      
                      {consulta.relatorio && (
                        <div style={{
                          backgroundColor: '#f8f9fa',
                          padding: '1rem',
                          borderRadius: '5px',
                          marginTop: '10px'
                        }}>
                          <h4 style={{ margin: '0 0 10px 0', color: '#2c3e50', fontSize: '14px' }}>Relat√≥rio da Consulta:</h4>
                          <p style={{ margin: 0, fontSize: '14px', color: '#666', lineHeight: 1.5 }}>
                            {consulta.relatorio}
                          </p>
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Pagamentos */}
        {abaSelecionada === 'pagamentos' && (
          <div>
            <h1 style={{ marginBottom: '2rem', color: '#2c3e50' }}>Pagamentos</h1>
            
            <div style={{ display: 'grid', gap: '1rem' }}>
              {userData.consultas.map((consulta: any) => (
                <div key={consulta.id} style={{ 
                  backgroundColor: 'white', 
                  padding: '1.5rem', 
                  borderRadius: '10px',
                  boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <h3 style={{ margin: '0 0 10px 0', color: '#2c3e50' }}>
                        Consulta - {new Date(consulta.data + 'T12:00:00').toLocaleDateString('pt-BR')}
                      </h3>
                      <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>
                        <strong>Hor√°rio:</strong> {consulta.hora}
                      </p>
                      <p style={{ margin: '0 0 5px 0', fontSize: '16px', fontWeight: '600' }}>
                        <strong>Valor:</strong> R$ 150,00
                      </p>
                      <p style={{ margin: 0 }}>
                        <strong>Status:</strong> 
                        <span style={{ 
                          marginLeft: '8px',
                          padding: '4px 8px',
                          borderRadius: '4px',
                          fontSize: '12px',
                          backgroundColor: 
                            consulta.pagamento === 'pago' ? '#d4edda' : 
                            consulta.pagamento === 'cancelado' ? '#f8d7da' : '#fff3cd',
                          color: 
                            consulta.pagamento === 'pago' ? '#155724' : 
                            consulta.pagamento === 'cancelado' ? '#721c24' : '#856404'
                        }}>
                          {consulta.pagamento === 'pago' ? 'Pago' : 
                           consulta.pagamento === 'cancelado' ? 'Cancelado' : 'Pendente'}
                        </span>
                      </p>
                    </div>
                    
                    <div>
                      {consulta.pagamento === 'pendente' && (
                        <div style={{ textAlign: 'center' }}>
                          <p style={{ margin: '0 0 10px 0', fontSize: '14px', color: '#666' }}>
                            Vencimento: {new Date(consulta.data).toLocaleDateString('pt-BR')}
                          </p>
                          <button
                            onClick={() => {
                              setConsultaSelecionada(consulta);
                              setCheckoutAberto(true);
                            }}
                            style={{
                              padding: '10px 20px',
                              backgroundColor: '#007bff',
                              color: 'white',
                              border: 'none',
                              borderRadius: '5px',
                              cursor: 'pointer',
                              fontWeight: '500'
                            }}
                          >
                            Pagar Agora
                          </button>
                        </div>
                      )}
                      
                      {consulta.pagamento === 'pago' && (
                        <div style={{ textAlign: 'center' }}>
                          <div style={{
                            width: '50px',
                            height: '50px',
                            backgroundColor: '#28a745',
                            borderRadius: '50%',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            margin: '0 auto 10px auto'
                          }}>
                            <span style={{ color: 'white', fontSize: '20px' }}>‚úì</span>
                          </div>
                          <p style={{ margin: 0, fontSize: '12px', color: '#666' }}>
                            Pago em {new Date(consulta.criadaEm).toLocaleDateString('pt-BR')}
                          </p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
            
            <div style={{
              backgroundColor: 'white',
              padding: '2rem',
              borderRadius: '10px',
              boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
              marginTop: '2rem'
            }}>
              <h3 style={{ marginBottom: '1rem', color: '#2c3e50' }}>Formas de Pagamento Aceitas</h3>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <span style={{ fontSize: '20px' }}>üí≥</span>
                  <span>PIX - Aprova√ß√£o instant√¢nea</span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <span style={{ fontSize: '20px' }}>üí≥</span>
                  <span>Cart√£o de Cr√©dito - At√© 12x</span>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Checkout Transparente */}
      {checkoutAberto && consultaSelecionada && (
        <CheckoutTransparente
          consulta={consultaSelecionada}
          paciente={userData.paciente}
          onPagamentoSucesso={() => {
            setCheckoutAberto(false);
            setConsultaSelecionada(null);
            // Atualizar dados sem recarregar a p√°gina para manter o login
            onAtualizarDados();
          }}
          onFechar={() => {
            setCheckoutAberto(false);
            setConsultaSelecionada(null);
          }}
        />
      )}
    </div>
  );
}

// Componente da √Årea da Psic√≥loga
function AreaPsicologa({ userData, onLogout }: { userData: any, onLogout: () => void }) {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [dashboardData, setDashboardData] = useState<any>(null);
  const [loading, setLoading] = useState(false);

  const loadDashboardData = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/area-restrita?action=dashboard');
      const data = await response.json();
      setDashboardData(data);
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
    } finally {
      setLoading(false);
    }
  };

  // Carregar dados do dashboard ao entrar
  useEffect(() => {
    if (activeTab === 'dashboard') {
      loadDashboardData();
    }
  }, [activeTab]);

  return (
    <div style={{ minHeight: '100vh', backgroundColor: '#f8f9fa', fontFamily: 'Arial, sans-serif' }}>
      <header style={{ 
        backgroundColor: '#ffffff', 
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)', 
        padding: '1rem 0' 
      }}>
        <nav style={{ 
          maxWidth: '1200px', 
          margin: '0 auto', 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          padding: '0 2rem'
        }}>
          <Link href="/" style={{ 
            fontSize: '1.5rem', 
            fontWeight: 'bold', 
            color: '#2c3e50',
            textDecoration: 'none'
          }}>
            Psic√≥loga Maria Cristina
          </Link>
          <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
            <span style={{ color: '#666' }}>Ol√°, {userData.nome}</span>
            <button 
              onClick={onLogout}
              style={{
                padding: '8px 16px',
                backgroundColor: '#e74c3c',
                color: 'white',
                border: 'none',
                borderRadius: '5px',
                cursor: 'pointer'
              }}
            >
              Sair
            </button>
          </div>
        </nav>
      </header>

      <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '2rem' }}>
        {/* Menu de navega√ß√£o */}
        <div style={{ 
          backgroundColor: 'white', 
          borderRadius: '10px', 
          padding: '1rem',
          marginBottom: '2rem',
          boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
          <div style={{ display: 'flex', gap: '1rem' }}>
            {[
              { key: 'dashboard', label: 'Dashboard' },
              { key: 'consultas', label: 'Consultas' },
              { key: 'pacientes', label: 'Pacientes' },
              { key: 'horarios', label: 'Hor√°rios' },
              { key: 'calendario', label: 'Calend√°rio' }
            ].map(tab => (
              <button
                key={tab.key}
                onClick={() => setActiveTab(tab.key)}
                style={{
                  padding: '10px 20px',
                  backgroundColor: activeTab === tab.key ? '#3498db' : 'transparent',
                  color: activeTab === tab.key ? 'white' : '#666',
                  border: 'none',
                  borderRadius: '5px',
                  cursor: 'pointer',
                  fontWeight: activeTab === tab.key ? '600' : '400'
                }}
              >
                {tab.label}
              </button>
            ))}
          </div>
        </div>

        {/* Conte√∫do das abas */}
        {activeTab === 'dashboard' && (
          <DashboardPsicologa 
            dashboardData={dashboardData} 
            loading={loading} 
            loadDashboardData={loadDashboardData}
          />
        )}
        
        {activeTab === 'consultas' && (
          <ConsultasPsicologa />
        )}
        
        {activeTab === 'pacientes' && (
          <PacientesPsicologa />
        )}
        
        {activeTab === 'horarios' && (
          <HorariosPsicologa />
        )}
        
        {activeTab === 'calendario' && (
          <CalendarioPsicologa />
        )}
      </div>
    </div>
  );
}

// Componentes das abas da psic√≥loga
function DashboardPsicologa({ 
  dashboardData, 
  loading, 
  loadDashboardData 
}: { 
  dashboardData: any, 
  loading: boolean,
  loadDashboardData: () => void 
}) {
  const marcarNotificacaoLida = async (notificacaoId?: string) => {
    try {
      await fetch('/api/area-restrita', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          notificacaoId, 
          marcarTodas: !notificacaoId 
        })
      });
      
      // Recarregar apenas os dados do dashboard sem recarregar a p√°gina
      loadDashboardData();
    } catch (error) {
      console.error('Erro ao marcar notifica√ß√£o como lida:', error);
    }
  };

  if (loading) return <div>Carregando...</div>;

  return (
    <div style={{ display: 'grid', gap: '2rem' }}>
      {/* Cards de estat√≠sticas */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1rem' }}>
        <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)', textAlign: 'center' }}>
          <h3 style={{ color: '#3498db', fontSize: '2rem', margin: '0 0 5px 0' }}>
            {dashboardData?.consultasHoje?.length || 0}
          </h3>
          <p style={{ margin: 0, color: '#666' }}>Consultas Hoje</p>
        </div>
        
        <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)', textAlign: 'center' }}>
          <h3 style={{ color: '#27ae60', fontSize: '2rem', margin: '0 0 5px 0' }}>
            {dashboardData?.consultasProximas?.length || 0}
          </h3>
          <p style={{ margin: 0, color: '#666' }}>Pr√≥ximos 7 dias</p>
        </div>
        
        <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)', textAlign: 'center' }}>
          <h3 style={{ color: '#f39c12', fontSize: '2rem', margin: '0 0 5px 0' }}>
            {dashboardData?.pacientes?.length || 0}
          </h3>
          <p style={{ margin: 0, color: '#666' }}>Total Pacientes</p>
        </div>
        
        <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)', textAlign: 'center' }}>
          <h3 style={{ color: '#e74c3c', fontSize: '2rem', margin: '0 0 5px 0' }}>
            {dashboardData?.notificacoes?.filter((n: any) => !n.lida).length || 0}
          </h3>
          <p style={{ margin: 0, color: '#666' }}>Notifica√ß√µes</p>
        </div>
      </div>

      {/* Consultas de hoje */}
      <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
        <h2 style={{ marginBottom: '1rem', color: '#2c3e50' }}>Consultas de Hoje</h2>
        {dashboardData?.consultasHoje?.length > 0 ? (
          <div style={{ display: 'grid', gap: '1rem' }}>
            {dashboardData.consultasHoje.map((consulta: any) => {
              const paciente = dashboardData.pacientes.find((p: any) => p.id === consulta.pacienteId);
              return (
                <div key={consulta.id} style={{ 
                  padding: '1rem', 
                  border: '1px solid #ddd', 
                  borderRadius: '5px',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <div>
                    <h4 style={{ margin: '0 0 5px 0' }}>{consulta.hora} - {paciente?.nome}</h4>
                    <p style={{ margin: 0, color: '#666' }}>Status: {consulta.status}</p>
                  </div>
                  <button style={{
                    padding: '8px 16px',
                    backgroundColor: '#27ae60',
                    color: 'white',
                    border: 'none',
                    borderRadius: '5px',
                    cursor: 'pointer'
                  }}>
                    Iniciar Consulta
                  </button>
                </div>
              );
            })}
          </div>
        ) : (
          <p style={{ color: '#666' }}>Nenhuma consulta agendada para hoje.</p>
        )}
      </div>

      {/* Notifica√ß√µes recentes */}
      <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
          <h2 style={{ margin: 0, color: '#2c3e50' }}>Notifica√ß√µes Recentes</h2>
          {dashboardData?.notificacoes?.some((n: any) => !n.lida) && (
            <button
              onClick={() => marcarNotificacaoLida()}
              style={{
                padding: '6px 12px',
                backgroundColor: '#17a2b8',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                fontSize: '12px'
              }}
            >
              Marcar Todas como Lidas
            </button>
          )}
        </div>
        
        {dashboardData?.notificacoes?.length > 0 ? (
          <div style={{ display: 'grid', gap: '1rem' }}>
            {dashboardData.notificacoes.slice(0, 5).map((notificacao: any) => (
              <div key={notificacao.id} style={{ 
                padding: '1rem', 
                backgroundColor: notificacao.lida ? '#f8f9fa' : '#fff3cd',
                borderRadius: '5px',
                border: '1px solid #ddd',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'flex-start'
              }}>
                <div style={{ flex: 1 }}>
                  <h4 style={{ margin: '0 0 5px 0', color: '#2c3e50' }}>{notificacao.titulo}</h4>
                  <p style={{ margin: '0 0 5px 0', color: '#666' }}>{notificacao.mensagem}</p>
                  <small style={{ color: '#999' }}>
                    {new Date(notificacao.criadaEm).toLocaleString('pt-BR')}
                  </small>
                </div>
                
                {!notificacao.lida && (
                  <button
                    onClick={() => marcarNotificacaoLida(notificacao.id)}
                    style={{
                      padding: '4px 8px',
                      backgroundColor: '#28a745',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '11px',
                      marginLeft: '10px'
                    }}
                  >
                    Marcar como Lida
                  </button>
                )}
              </div>
            ))}
          </div>
        ) : (
          <p style={{ color: '#666' }}>Nenhuma notifica√ß√£o.</p>
        )}
      </div>
    </div>
  );
}

function ConsultasPsicologa() {
  const [consultas, setConsultas] = useState([]);
  const [loading, setLoading] = useState(true);
  const [consultaSelecionada, setConsultaSelecionada] = useState<any>(null);
  const [modalAberto, setModalAberto] = useState(false);

  useEffect(() => {
    carregarConsultas();
  }, []);

  const carregarConsultas = async () => {
    try {
      const response = await fetch('/api/area-restrita?action=consultas');
      const data = await response.json();
      setConsultas(data);
    } catch (error) {
      console.error('Erro ao carregar consultas:', error);
    } finally {
      setLoading(false);
    }
  };

  const atualizarConsulta = async (consultaId: string, updates: any) => {
    try {
      const response = await fetch('/api/area-restrita', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ consultaId, updates })
      });

      if (response.ok) {
        carregarConsultas();
        setModalAberto(false);
        setConsultaSelecionada(null);
        alert('Consulta atualizada com sucesso!');
      }
    } catch (error) {
      console.error('Erro ao atualizar consulta:', error);
      alert('Erro ao atualizar consulta');
    }
  };

  const iniciarConsulta = async (consulta: any) => {
    const linkMeet = `https://meet.google.com/${Math.random().toString(36).substring(2, 15)}`;
    await atualizarConsulta(consulta.id, {
      status: 'confirmada',
      linkMeet
    });
  };

  if (loading) return <div>Carregando...</div>;

  return (
    <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
      <h2 style={{ marginBottom: '2rem', color: '#2c3e50' }}>Gerenciar Consultas</h2>
      
      <div style={{ display: 'grid', gap: '1rem' }}>
        {consultas.length === 0 ? (
          <p style={{ color: '#666' }}>Nenhuma consulta encontrada.</p>
        ) : (
          consultas.map((consulta: any) => (
            <div key={consulta.id} style={{
              border: '1px solid #ddd',
              borderRadius: '8px',
              padding: '1.5rem',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <div>
                <h3 style={{ margin: '0 0 10px 0', color: '#2c3e50' }}>
                  {new Date(consulta.data + 'T12:00:00').toLocaleDateString('pt-BR')} - {consulta.hora}
                </h3>
                <p style={{ margin: '0 0 5px 0' }}>
                  <strong>Paciente:</strong> {consulta.paciente?.nome}
                </p>
                <p style={{ margin: '0 0 5px 0' }}>
                  <strong>Status:</strong> 
                  <span style={{
                    marginLeft: '8px',
                    padding: '4px 8px',
                    borderRadius: '4px',
                    fontSize: '12px',
                    backgroundColor: 
                      consulta.status === 'agendada' ? '#fff3cd' :
                      consulta.status === 'confirmada' ? '#d4edda' :
                      consulta.status === 'realizada' ? '#d1ecf1' : '#f8d7da',
                    color:
                      consulta.status === 'agendada' ? '#856404' :
                      consulta.status === 'confirmada' ? '#155724' :
                      consulta.status === 'realizada' ? '#0c5460' : '#721c24'
                  }}>
                    {consulta.status.charAt(0).toUpperCase() + consulta.status.slice(1)}
                  </span>
                </p>
                <p style={{ margin: 0 }}>
                  <strong>Pagamento:</strong>
                  <span style={{
                    marginLeft: '8px',
                    padding: '4px 8px',
                    borderRadius: '4px',
                    fontSize: '12px',
                    backgroundColor: consulta.pagamento === 'pago' ? '#d4edda' : '#fff3cd',
                    color: consulta.pagamento === 'pago' ? '#155724' : '#856404'
                  }}>
                    {consulta.pagamento.charAt(0).toUpperCase() + consulta.pagamento.slice(1)}
                  </span>
                </p>
              </div>
              
              <div style={{ display: 'flex', gap: '10px', flexDirection: 'column' }}>
                <button
                  onClick={() => {
                    setConsultaSelecionada(consulta);
                    setModalAberto(true);
                  }}
                  style={{
                    padding: '8px 16px',
                    backgroundColor: '#3498db',
                    color: 'white',
                    border: 'none',
                    borderRadius: '5px',
                    cursor: 'pointer',
                    fontSize: '14px'
                  }}
                >
                  Editar
                </button>
                
                {consulta.status === 'agendada' && (
                  <button
                    onClick={() => iniciarConsulta(consulta)}
                    style={{
                      padding: '8px 16px',
                      backgroundColor: '#27ae60',
                      color: 'white',
                      border: 'none',
                      borderRadius: '5px',
                      cursor: 'pointer',
                      fontSize: '14px'
                    }}
                  >
                    Iniciar
                  </button>
                )}
                
                {consulta.linkMeet && (
                  <a
                    href={consulta.linkMeet}
                    target="_blank"
                    rel="noopener noreferrer"
                    style={{
                      padding: '8px 16px',
                      backgroundColor: '#f39c12',
                      color: 'white',
                      textDecoration: 'none',
                      borderRadius: '5px',
                      textAlign: 'center',
                      fontSize: '14px'
                    }}
                  >
                    Abrir Meet
                  </a>
                )}
              </div>
            </div>
          ))
        )}
      </div>

      {/* Modal de edi√ß√£o */}
      {modalAberto && consultaSelecionada && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.5)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 1000
        }}>
          <div style={{
            backgroundColor: 'white',
            padding: '2rem',
            borderRadius: '10px',
            minWidth: '500px',
            maxHeight: '80vh',
            overflow: 'auto'
          }}>
            <h3 style={{ marginBottom: '1rem' }}>Editar Consulta</h3>
            
            <div style={{ marginBottom: '1rem' }}>
              <label style={{ display: 'block', marginBottom: '5px' }}>Status:</label>
              <select
                value={consultaSelecionada.status}
                onChange={(e) => setConsultaSelecionada({...consultaSelecionada, status: e.target.value})}
                style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '5px' }}
              >
                <option value="agendada">Agendada</option>
                <option value="confirmada">Confirmada</option>
                <option value="realizada">Realizada</option>
                <option value="cancelada">Cancelada</option>
                <option value="nao_compareceu">N√£o Compareceu</option>
              </select>
            </div>

            <div style={{ marginBottom: '1rem' }}>
              <label style={{ display: 'block', marginBottom: '5px' }}>Pagamento:</label>
              <select
                value={consultaSelecionada.pagamento}
                onChange={(e) => setConsultaSelecionada({...consultaSelecionada, pagamento: e.target.value})}
                style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '5px' }}
              >
                <option value="pendente">Pendente</option>
                <option value="pago">Pago</option>
                <option value="cancelado">Cancelado</option>
              </select>
            </div>

            <div style={{ marginBottom: '1rem' }}>
              <label style={{ display: 'block', marginBottom: '5px' }}>Link do Meet:</label>
              <input
                type="url"
                value={consultaSelecionada.linkMeet || ''}
                onChange={(e) => setConsultaSelecionada({...consultaSelecionada, linkMeet: e.target.value})}
                placeholder="https://meet.google.com/..."
                style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '5px' }}
              />
            </div>

            <div style={{ marginBottom: '1rem' }}>
              <label style={{ display: 'block', marginBottom: '5px' }}>Observa√ß√µes:</label>
              <textarea
                value={consultaSelecionada.observacoes || ''}
                onChange={(e) => setConsultaSelecionada({...consultaSelecionada, observacoes: e.target.value})}
                rows={3}
                style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '5px' }}
              />
            </div>

            <div style={{ marginBottom: '2rem' }}>
              <label style={{ display: 'block', marginBottom: '5px' }}>Relat√≥rio:</label>
              <textarea
                value={consultaSelecionada.relatorio || ''}
                onChange={(e) => setConsultaSelecionada({...consultaSelecionada, relatorio: e.target.value})}
                rows={4}
                style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '5px' }}
              />
            </div>

            <div style={{ display: 'flex', gap: '1rem' }}>
              <button
                onClick={() => {
                  setModalAberto(false);
                  setConsultaSelecionada(null);
                }}
                style={{
                  padding: '10px 20px',
                  border: '1px solid #ddd',
                  backgroundColor: 'white',
                  borderRadius: '5px',
                  cursor: 'pointer'
                }}
              >
                Cancelar
              </button>
              <button
                onClick={() => atualizarConsulta(consultaSelecionada.id, {
                  status: consultaSelecionada.status,
                  pagamento: consultaSelecionada.pagamento,
                  linkMeet: consultaSelecionada.linkMeet,
                  observacoes: consultaSelecionada.observacoes,
                  relatorio: consultaSelecionada.relatorio
                })}
                style={{
                  padding: '10px 20px',
                  backgroundColor: '#3498db',
                  color: 'white',
                  border: 'none',
                  borderRadius: '5px',
                  cursor: 'pointer'
                }}
              >
                Salvar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function PacientesPsicologa() {
  const [pacientes, setPacientes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [pacienteSelecionado, setPacienteSelecionado] = useState<any>(null);

  useEffect(() => {
    carregarPacientes();
  }, []);

  const carregarPacientes = async () => {
    try {
      const response = await fetch('/api/area-restrita?action=pacientes');
      const data = await response.json();
      setPacientes(data);
    } catch (error) {
      console.error('Erro ao carregar pacientes:', error);
    } finally {
      setLoading(false);
    }
  };

  const carregarDetalhesPaciente = async (pacienteId: string) => {
    try {
      const response = await fetch(`/api/area-restrita?action=pacientes&id=${pacienteId}`);
      const data = await response.json();
      setPacienteSelecionado(data);
    } catch (error) {
      console.error('Erro ao carregar detalhes do paciente:', error);
    }
  };

  if (loading) return <div>Carregando...</div>;

  return (
    <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
      <h2 style={{ marginBottom: '2rem', color: '#2c3e50' }}>Pacientes</h2>
      
      {!pacienteSelecionado ? (
        <div>
          {pacientes.length === 0 ? (
            <p style={{ color: '#666' }}>Nenhum paciente cadastrado.</p>
          ) : (
            <div style={{ display: 'grid', gap: '1rem' }}>
              {pacientes.map((paciente: any) => (
                <div key={paciente.id} style={{
                  border: '1px solid #ddd',
                  borderRadius: '8px',
                  padding: '1.5rem',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <div>
                    <h3 style={{ margin: '0 0 10px 0', color: '#2c3e50' }}>{paciente.nome}</h3>
                    <p style={{ margin: '0 0 5px 0', color: '#666' }}>
                      <strong>Email:</strong> {paciente.email}
                    </p>
                    <p style={{ margin: '0 0 5px 0', color: '#666' }}>
                      <strong>Telefone:</strong> {paciente.telefone}
                    </p>
                    <p style={{ margin: 0, color: '#666' }}>
                      <strong>Cadastrado em:</strong> {new Date(paciente.criadoEm).toLocaleDateString('pt-BR')}
                    </p>
                  </div>
                  
                  <button
                    onClick={() => carregarDetalhesPaciente(paciente.id)}
                    style={{
                      padding: '10px 20px',
                      backgroundColor: '#3498db',
                      color: 'white',
                      border: 'none',
                      borderRadius: '5px',
                      cursor: 'pointer'
                    }}
                  >
                    Ver Detalhes
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      ) : (
        <div>
          <button
            onClick={() => setPacienteSelecionado(null)}
            style={{
              padding: '8px 16px',
              backgroundColor: '#6c757d',
              color: 'white',
              border: 'none',
              borderRadius: '5px',
              cursor: 'pointer',
              marginBottom: '2rem'
            }}
          >
            ‚Üê Voltar √† Lista
          </button>

          <div style={{ marginBottom: '2rem' }}>
            <h3 style={{ color: '#2c3e50', marginBottom: '1rem' }}>Dados do Paciente</h3>
            <div style={{ 
              backgroundColor: '#f8f9fa', 
              padding: '1.5rem', 
              borderRadius: '8px',
              display: 'grid',
              gridTemplateColumns: 'repeat(2, 1fr)',
              gap: '1rem'
            }}>
              <div>
                <p><strong>Nome:</strong> {pacienteSelecionado.nome}</p>
                <p><strong>Email:</strong> {pacienteSelecionado.email}</p>
                <p><strong>Telefone:</strong> {pacienteSelecionado.telefone}</p>
              </div>
              <div>
                <p><strong>CPF:</strong> {pacienteSelecionado.cpf}</p>
                <p><strong>Data de Nascimento:</strong> {new Date(pacienteSelecionado.dataNascimento).toLocaleDateString('pt-BR')}</p>
                <p><strong>Cadastrado em:</strong> {new Date(pacienteSelecionado.criadoEm).toLocaleDateString('pt-BR')}</p>
              </div>
              
              {pacienteSelecionado.responsavel && (
                <>
                  <div>
                    <p><strong>Respons√°vel:</strong> {pacienteSelecionado.responsavel}</p>
                  </div>
                  <div>
                    <p><strong>Tel. Respons√°vel:</strong> {pacienteSelecionado.telefoneResponsavel}</p>
                  </div>
                </>
              )}
            </div>
          </div>

          <div>
            <h3 style={{ color: '#2c3e50', marginBottom: '1rem' }}>Hist√≥rico de Consultas</h3>
            {pacienteSelecionado.consultas?.length === 0 ? (
              <p style={{ color: '#666' }}>Nenhuma consulta encontrada para este paciente.</p>
            ) : (
              <div style={{ display: 'grid', gap: '1rem' }}>
                {pacienteSelecionado.consultas?.map((consulta: any) => (
                  <div key={consulta.id} style={{
                    border: '1px solid #ddd',
                    borderRadius: '8px',
                    padding: '1rem'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <h4 style={{ margin: '0 0 10px 0', color: '#2c3e50' }}>
                          {new Date(consulta.data + 'T12:00:00').toLocaleDateString('pt-BR')} - {consulta.hora}
                        </h4>
                        <p style={{ margin: '0 0 5px 0' }}>
                          <strong>Status:</strong>
                          <span style={{
                            marginLeft: '8px',
                            padding: '4px 8px',
                            borderRadius: '4px',
                            fontSize: '12px',
                            backgroundColor: 
                              consulta.status === 'agendada' ? '#fff3cd' :
                              consulta.status === 'confirmada' ? '#d4edda' :
                              consulta.status === 'realizada' ? '#d1ecf1' : '#f8d7da'
                          }}>
                            {consulta.status.charAt(0).toUpperCase() + consulta.status.slice(1)}
                          </span>
                        </p>
                        {consulta.observacoes && (
                          <p style={{ margin: '5px 0', fontSize: '14px', color: '#666' }}>
                            <strong>Observa√ß√µes:</strong> {consulta.observacoes}
                          </p>
                        )}
                        {consulta.relatorio && (
                          <p style={{ margin: '5px 0', fontSize: '14px', color: '#666' }}>
                            <strong>Relat√≥rio:</strong> {consulta.relatorio}
                          </p>
                        )}
                      </div>
                      
                      <div>
                        <span style={{
                          padding: '4px 8px',
                          borderRadius: '4px',
                          fontSize: '12px',
                          backgroundColor: consulta.pagamento === 'pago' ? '#d4edda' : '#fff3cd',
                          color: consulta.pagamento === 'pago' ? '#155724' : '#856404'
                        }}>
                          {consulta.pagamento.charAt(0).toUpperCase() + consulta.pagamento.slice(1)}
                        </span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

function HorariosPsicologa() {
  const [horarios, setHorarios] = useState([]);
  const [loading, setLoading] = useState(true);
  const [novoHorario, setNovoHorario] = useState({
    data: '',
    hora: '',
    tipo: 'unico',
    diaSemana: 1
  });

  useEffect(() => {
    carregarHorarios();
  }, []);

  const carregarHorarios = async () => {
    try {
      const response = await fetch('/api/horarios');
      const data = await response.json();
      setHorarios(data);
    } catch (error) {
      console.error('Erro ao carregar hor√°rios:', error);
    } finally {
      setLoading(false);
    }
  };

  const criarHorario = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const response = await fetch('/api/horarios', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(novoHorario)
      });

      if (response.ok) {
        alert('Hor√°rio criado com sucesso!');
        setNovoHorario({ data: '', hora: '', tipo: 'unico', diaSemana: 1 });
        carregarHorarios();
      } else {
        const error = await response.json();
        alert(error.error);
      }
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao criar hor√°rio');
    }
  };

  const deletarHorario = async (id: string) => {
    if (confirm('Tem certeza que deseja deletar este hor√°rio?')) {
      try {
        const response = await fetch(`/api/horarios?id=${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Hor√°rio deletado com sucesso!');
          carregarHorarios();
        } else {
          alert('Erro ao deletar hor√°rio');
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar hor√°rio');
      }
    }
  };

  const diasSemana = ['', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];

  if (loading) return <div>Carregando...</div>;

  return (
    <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
      <h2 style={{ marginBottom: '2rem', color: '#2c3e50' }}>Gerenciar Hor√°rios</h2>
      
      <form onSubmit={criarHorario} style={{ marginBottom: '3rem', backgroundColor: '#f8f9fa', padding: '2rem', borderRadius: '8px' }}>
        <h3 style={{ marginBottom: '1rem', color: '#2c3e50' }}>Adicionar Novo Hor√°rio</h3>
        
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1rem', marginBottom: '1rem' }}>
          <div>
            <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Tipo</label>
            <select
              value={novoHorario.tipo}
              onChange={(e) => setNovoHorario(prev => ({ ...prev, tipo: e.target.value }))}
              style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '5px' }}
            >
              <option value="unico">√önico</option>
              <option value="recorrente">Recorrente</option>
            </select>
          </div>
          
          {novoHorario.tipo === 'unico' && (
            <div>
              <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Data</label>
              <input
                type="date"
                value={novoHorario.data}
                onChange={(e) => setNovoHorario(prev => ({ ...prev, data: e.target.value }))}
                style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '5px' }}
                required={novoHorario.tipo === 'unico'}
              />
            </div>
          )}
          
          {novoHorario.tipo === 'recorrente' && (
            <div>
              <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Dia da Semana</label>
              <select
                value={novoHorario.diaSemana}
                onChange={(e) => setNovoHorario(prev => ({ ...prev, diaSemana: parseInt(e.target.value) }))}
                style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '5px' }}
              >
                <option value={1}>Segunda</option>
                <option value={2}>Ter√ßa</option>
                <option value={3}>Quarta</option>
                <option value={4}>Quinta</option>
                <option value={5}>Sexta</option>
              </select>
            </div>
          )}
          
          <div>
            <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Hor√°rio</label>
            <input
              type="time"
              value={novoHorario.hora}
              onChange={(e) => setNovoHorario(prev => ({ ...prev, hora: e.target.value }))}
              style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '5px' }}
              required
            />
          </div>
        </div>
        
        <button
          type="submit"
          style={{
            padding: '10px 20px',
            backgroundColor: '#27ae60',
            color: 'white',
            border: 'none',
            borderRadius: '5px',
            cursor: 'pointer',
            fontWeight: '500'
          }}
        >
          Adicionar Hor√°rio
        </button>
      </form>

      <div>
        <h3 style={{ marginBottom: '1rem', color: '#2c3e50' }}>Hor√°rios Cadastrados</h3>
        
        {horarios.length === 0 ? (
          <p style={{ color: '#666' }}>Nenhum hor√°rio cadastrado.</p>
        ) : (
          <div style={{ display: 'grid', gap: '1rem' }}>
            {horarios.map((horario: any) => (
              <div key={horario.id} style={{
                border: '1px solid #ddd',
                borderRadius: '8px',
                padding: '1.5rem',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                backgroundColor: horario.ativo ? 'white' : '#f8f9fa'
              }}>
                <div>
                  <h4 style={{ margin: '0 0 5px 0', color: '#2c3e50' }}>
                    {horario.tipo === 'unico' 
                      ? `${new Date(horario.data + 'T12:00:00').toLocaleDateString('pt-BR')} - ${horario.hora}`
                      : `${diasSemana[horario.diaSemana]} - ${horario.hora}`
                    }
                  </h4>
                  <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>
                    <strong>Tipo:</strong> {horario.tipo === 'unico' ? 'Hor√°rio √önico' : 'Recorrente'}
                  </p>
                  <p style={{ margin: 0, fontSize: '14px', color: '#666' }}>
                    <strong>Status:</strong>
                    <span style={{
                      marginLeft: '8px',
                      padding: '2px 6px',
                      borderRadius: '4px',
                      fontSize: '12px',
                      backgroundColor: horario.ativo ? '#d4edda' : '#f8d7da',
                      color: horario.ativo ? '#155724' : '#721c24'
                    }}>
                      {horario.ativo ? 'Ativo' : 'Inativo'}
                    </span>
                  </p>
                </div>
                
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button
                    onClick={() => deletarHorario(horario.id)}
                    style={{
                      padding: '8px 16px',
                      backgroundColor: '#e74c3c',
                      color: 'white',
                      border: 'none',
                      borderRadius: '5px',
                      cursor: 'pointer',
                      fontSize: '14px'
                    }}
                  >
                    Deletar
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

function CalendarioPsicologa() {
  const [consultas, setConsultas] = useState([]);
  const [horarios, setHorarios] = useState([]);
  const [loading, setLoading] = useState(true);
  const [dataSelecionada, setDataSelecionada] = useState('');
  const [consultasDia, setConsultasDia] = useState([]);

  useEffect(() => {
    carregarDadosCalendario();
  }, []);

  const carregarDadosCalendario = async () => {
    try {
      const [consultasRes, horariosRes] = await Promise.all([
        fetch('/api/area-restrita?action=consultas'),
        fetch('/api/horarios')
      ]);

      const consultasData = await consultasRes.json();
      const horariosData = await horariosRes.json();

      setConsultas(consultasData);
      setHorarios(horariosData);
    } catch (error) {
      console.error('Erro ao carregar dados do calend√°rio:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleDateSelect = (date: string) => {
    setDataSelecionada(date);
    const consultasData = consultas.filter((c: any) => c.data === date);
    setConsultasDia(consultasData);
  };

  // Preparar dados para o calend√°rio
  const consultasData = consultas.map((c: any) => c.data);
  const disponibilidadesData = horarios
    .filter((h: any) => h.ativo)
    .map((h: any) => h.tipo === 'unico' ? h.data : null)
    .filter(Boolean);

  if (loading) return <div>Carregando...</div>;

  return (
    <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
      <h2 style={{ marginBottom: '2rem', color: '#2c3e50' }}>Calend√°rio</h2>
      
      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '2rem' }}>
        <div>
          <Calendario 
            consultasData={consultasData} 
            disponibilidadesData={disponibilidadesData} 
            onDateSelect={handleDateSelect}
            selectedDate={dataSelecionada}
          />
        </div>

        <div>
          <h3 style={{ marginBottom: '1rem', color: '#2c3e50' }}>
            {dataSelecionada 
              ? `Consultas de ${new Date(dataSelecionada + 'T12:00:00').toLocaleDateString('pt-BR')}`
              : 'Selecione uma data'
            }
          </h3>

          {dataSelecionada && (
            <div style={{ display: 'grid', gap: '1rem' }}>
              {consultasDia.length === 0 ? (
                <p style={{ color: '#666' }}>Nenhuma consulta neste dia.</p>
              ) : (
                consultasDia.map((consulta: any) => (
                  <div key={consulta.id} style={{
                    border: '1px solid #ddd',
                    borderRadius: '8px',
                    padding: '1rem',
                    backgroundColor: '#f8f9fa'
                  }}>
                    <h4 style={{ margin: '0 0 10px 0', color: '#2c3e50' }}>
                      {consulta.hora} - {consulta.paciente?.nome}
                    </h4>
                    <p style={{ margin: '0 0 5px 0', fontSize: '14px' }}>
                      <strong>Status:</strong>
                      <span style={{
                        marginLeft: '8px',
                        padding: '2px 6px',
                        borderRadius: '4px',
                        fontSize: '12px',
                        backgroundColor: 
                          consulta.status === 'agendada' ? '#fff3cd' :
                          consulta.status === 'confirmada' ? '#d4edda' :
                          consulta.status === 'realizada' ? '#d1ecf1' : '#f8d7da'
                      }}>
                        {consulta.status}
                      </span>
                    </p>
                    <p style={{ margin: 0, fontSize: '14px' }}>
                      <strong>Pagamento:</strong>
                      <span style={{
                        marginLeft: '8px',
                        padding: '2px 6px',
                        borderRadius: '4px',
                        fontSize: '12px',
                        backgroundColor: consulta.pagamento === 'pago' ? '#d4edda' : '#fff3cd'
                      }}>
                        {consulta.pagamento}
                      </span>
                    </p>
                  </div>
                ))
              )}
            </div>
          )}

          {!dataSelecionada && (
            <div style={{
              padding: '2rem',
              textAlign: 'center',
              color: '#666',
              backgroundColor: '#f8f9fa',
              borderRadius: '8px',
              border: '2px dashed #ddd'
            }}>
              <p>Clique em uma data no calend√°rio para ver as consultas do dia</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}